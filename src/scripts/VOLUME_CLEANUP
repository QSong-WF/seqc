#!/usr/local/bin/python3
import sys
import boto3
from os.path import expanduser
from subprocess import call


def main():
    ec2 = boto3.resource('ec2')
    home = expanduser("~")
    fpath = home + "/.starcluster/plugins/vol_names.txt"

    try:
        with open(fpath, 'r') as f:
            vol_names = [line.strip() for line in f]
    except IOError:
        print('No new volumes for cleanup!')
        sys.exit(2)

    remain_vol = []
    for name in vol_names:
        volume = ec2.Volume(name)
        if not volume.attachments:
            call(["aws", "ec2", "delete-volume", "--volume-id", name])
        else:
            remain_vol.append(name)
    print('Finished deleting all new, unattached volumes')
    print('There are %d new volumes still being used' % len(remain_vol))

    # updating vol_names.txt file
    call(["rm", fpath])
    if remain_vol:
        with open(fpath, 'w') as f:
            for name in remain_vol:
                f.write('%s\n' % name)


if __name__ == "__main__":
    help = """
	VOLUME_CLEANUP iterates through all newly created volumes
	and deletes any that is not currently being used.
	"""
    if len(sys.argv) > 1:
        print(help)
        sys.exit(2)
    else:
        main()
